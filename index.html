<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mis Puntos de Inter√©s</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#FF6B6B">

    <style>
        :root {
            --primary: #FF6B6B; --secondary: #4ECDC4; --dark: #2C3E50;
            --light: #F7F9FC; --shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        body, html { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; height: 100%; overflow: hidden; }
        
        /* Splash Screen */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease;
        }
        #loader img { width: 120px; height: 120px; border-radius: 25%; box-shadow: var(--shadow); animation: pulse 2s infinite; }
        #loader p { color: white; margin-top: 20px; font-weight: 600; letter-spacing: 1px; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* Mapa y Controles */
        #map { width: 100%; height: 100vh; z-index: 1; }
        .controls { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 1000; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 8px; }
        .filter-box { background: white; padding: 8px 15px; border-radius: 20px; box-shadow: var(--shadow); }
        select { border: none; width: 100%; font-family: inherit; font-weight: 600; outline: none; }

        .gps-btn {
            position: fixed; bottom: 30px; right: 20px; width: 55px; height: 55px;
            background: white; border: none; border-radius: 50%; z-index: 1000;
            box-shadow: var(--shadow); color: var(--secondary); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        /* Modales */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 25px; border-radius: 25px; width: 85%; max-width: 350px; }
        input, textarea, select.form-input { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #eee; border-radius: 12px; box-sizing: border-box; font-family: inherit; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn-save { background: var(--secondary); color: white; flex: 2; border: none; padding: 12px; border-radius: 12px; font-weight: 600; }
        .btn-cancel { background: #eee; color: var(--dark); flex: 1; border: none; padding: 12px; border-radius: 12px; }
        .btn-delete { background: var(--primary); color: white; width: 100%; margin-top: 10px; border: none; padding: 12px; border-radius: 12px; }

        .custom-marker { display: flex; justify-content: center; align-items: center; color: white; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-weight: bold; }
    </style>
</head>
<body>

    <div id="loader">
        <img src="./icon.png" alt="Icono" onerror="this.src='https://cdn-icons-png.flaticon.com/512/854/854878.png'">
        <p>MIS VIAJES</p>
    </div>

    <div class="controls">
        <div class="filter-box"><select id="cityFilter"><option value="all">üåç Todas las ciudades</option></select></div>
        <div class="filter-box">
            <select id="catFilter">
                <option value="all">üè∑Ô∏è Todas las categor√≠as</option>
                <option value="Comida">üçî Comida</option><option value="Turismo">üì∏ Turismo</option>
                <option value="Ocio">üçπ Ocio</option><option value="Alojamiento">üõèÔ∏è Alojamiento</option>
                <option value="Otro">üìå Otro</option>
            </select>
        </div>
    </div>

    <div id="map"></div>

    <button class="gps-btn" onclick="locateUser()">
        <svg width="28" height="28" viewBox="0 0 24 24"><path fill="currentColor" d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M3.05,13H1V11H3.05C3.5,6.83 6.83,3.5 11,3.05V1H13V3.05C17.17,3.5 20.5,6.83 20.95,11H23V13H20.95C20.5,17.17 17.17,20.5 13,20.95V23H11V20.95C6.83,20.5 3.5,17.17 3.05,13Z" /></svg>
    </button>

    <div id="poiModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-top:0; color:var(--primary)">Punto de Inter√©s</h2>
            <form id="poiForm">
                <input type="hidden" id="poiId">
                <input type="hidden" id="poiLat"><input type="hidden" id="poiLng">
                <input type="text" id="poiName" placeholder="Nombre" required>
                <textarea id="poiDesc" placeholder="Descripci√≥n"></textarea>
                <select id="poiCat" class="form-input">
                    <option value="Comida">üçî Comida</option><option value="Turismo">üì∏ Turismo</option>
                    <option value="Ocio">üçπ Ocio</option><option value="Alojamiento">üõèÔ∏è Alojamiento</option>
                    <option value="Otro">üìå Otro</option>
                </select>
                <input type="text" id="poiCity" placeholder="Ciudad" required>
                <div class="btn-group">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cerrar</button>
                    <button type="submit" class="btn-save" id="saveBtn">Guardar</button>
                </div>
                <button type="button" id="deleteBtn" class="btn-delete" onclick="deletePoint()">Eliminar</button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx2lzGsngRn9jK3r0clhms4so0PUhJ8JplJPToMk1fckb02x-ff2TGUzrR7RiXLmovtdA/exec"; 
        let map, markersLayer = L.layerGroup(), allData = [], userMarker;

        const catColors = { 'Comida': '#FF6B6B', 'Turismo': '#4ECDC4', 'Ocio': '#FFE66D', 'Alojamiento': '#A06CD5', 'Otro': '#95A5A6' };
        const catIcons = { 'Comida': 'üçî', 'Turismo': 'üì∏', 'Ocio': 'üçπ', 'Alojamiento': 'üõèÔ∏è', 'Otro': 'üìå' };

        window.onload = () => { initMap(); loadData(); };

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([40.41, -3.7], 6);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
            markersLayer.addTo(map);
            map.on('click', e => openModal('create', { lat: e.latlng.lat, lng: e.latlng.lng }));
            
            map.on('locationfound', e => {
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.circleMarker(e.latlng, { radius: 8, fillColor: "#3388ff", color: "#fff", weight: 2, fillOpacity: 0.8 }).addTo(map);
                map.flyTo(e.latlng, 15);
            });
        }

        async function loadData() {
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL);
                allData = await res.json();
                renderMarkers(allData);
                updateCityFilter(allData);
                setTimeout(() => { 
                    document.getElementById('loader').style.opacity = '0';
                    setTimeout(() => document.getElementById('loader').style.display = 'none', 800);
                }, 1500);
            } catch (e) { console.error(e); }
        }

        function renderMarkers(data) {
            markersLayer.clearLayers();
            data.forEach(p => {
                const icon = L.divIcon({
                    className: '',
                    html: `<div class="custom-marker" style="background:${catColors[p.categoria]||'#95A5A6'};width:30px;height:30px">${catIcons[p.categoria]||'üìå'}</div>`,
                    iconSize: [30, 30], iconAnchor: [15, 15]
                });
                const m = L.marker([p.lat, p.lng], { icon }).addTo(markersLayer);
                m.bindPopup(`<b>${p.nombre}</b>`);
                m.on('click', e => { L.DomEvent.stopPropagation(e); openModal('edit', p); });
            });
        }

        function openModal(mode, data) {
            document.getElementById('poiForm').reset();
            const isEdit = mode === 'edit';
            document.getElementById('poiId').value = isEdit ? data.id : "";
            document.getElementById('poiLat').value = data.lat;
            document.getElementById('poiLng').value = data.lng;
            if(isEdit) {
                document.getElementById('poiName').value = data.nombre;
                document.getElementById('poiDesc').value = data.descripcion;
                document.getElementById('poiCat').value = data.categoria;
                document.getElementById('poiCity').value = data.ciudad;
            }
            document.getElementById('deleteBtn').style.display = isEdit ? 'block' : 'none';
            document.getElementById('poiModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('poiModal').style.display = 'none'; }

        function updateCityFilter(data) {
            const select = document.getElementById('cityFilter');
            const cities = [...new Set(data.map(p => p.ciudad))].sort();
            select.innerHTML = '<option value="all">üåç Todas las ciudades</option>';
            cities.forEach(c => { if(c) select.innerHTML += `<option value="${c}">${c}</option>`; });
        }

        function filterData() {
            const city = document.getElementById('cityFilter').value;
            const cat = document.getElementById('catFilter').value;
            const filtered = allData.filter(p => (city === 'all' || p.ciudad === city) && (cat === 'all' || p.categoria === cat));
            renderMarkers(filtered);
            if(city !== 'all' && filtered.length > 0) map.flyTo([filtered[0].lat, filtered[0].lng], 13);
        }

        document.getElementById('cityFilter').onchange = filterData;
        document.getElementById('catFilter').onchange = filterData;

        function locateUser() { map.locate({enableHighAccuracy: true}); }

        document.getElementById('poiForm').onsubmit = e => {
            e.preventDefault();
            const payload = {
                action: document.getElementById('poiId').value ? 'update' : 'create',
                id: document.getElementById('poiId').value,
                lat: document.getElementById('poiLat').value,
                lng: document.getElementById('poiLng').value,
                nombre: document.getElementById('poiName').value,
                descripcion: document.getElementById('poiDesc').value,
                categoria: document.getElementById('poiCat').value,
                ciudad: document.getElementById('poiCity').value
            };
            sendToSheet(payload);
        };

        function deletePoint() { if(confirm("¬øBorrar?")) sendToSheet({action:'delete', id: document.getElementById('poiId').value}); }

        function sendToSheet(payload) {
            document.getElementById('saveBtn').disabled = true;
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(() => { closeModal(); loadData(); })
            .catch(() => { closeModal(); loadData(); })
            .finally(() => document.getElementById('saveBtn').disabled = false);
        }
    </script>
</body>
</html>